<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Vanguard Data Explorer</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
        sans-serif;
      background: #1a1a2e;
      color: #eee;
      min-height: 100vh;
    }

    .header {
      background: #16213e;
      padding: 1rem 2rem;
      border-bottom: 1px solid #0f3460;
      display: flex;
      align-items: center;
      gap: 2rem;
    }

    .header h1 {
      font-size: 1.5rem;
      color: #e94560;
    }

    .header .stats {
      color: #888;
      font-size: 0.9rem;
    }

    .container {
      display: flex;
      height: calc(100vh - 60px);
    }

    .sidebar {
      width: 280px;
      background: #16213e;
      border-right: 1px solid #0f3460;
      overflow-y: auto;
      padding: 1rem;
    }

    .sidebar h3 {
      color: #e94560;
      margin-bottom: 0.5rem;
      font-size: 0.9rem;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .class-list {
      list-style: none;
    }

    .class-item {
      padding: 0.5rem 0.75rem;
      cursor: pointer;
      border-radius: 4px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 0.9rem;
    }

    .class-item:hover {
      background: #0f3460;
    }

    .class-item.active {
      background: #e94560;
      color: white;
    }

    .class-item .count {
      color: #888;
      font-size: 0.8rem;
    }

    .class-item.active .count {
      color: rgba(255, 255, 255, 0.8);
    }

    .main {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .toolbar {
      background: #16213e;
      padding: 1rem;
      border-bottom: 1px solid #0f3460;
      display: flex;
      gap: 1rem;
      align-items: center;
      flex-wrap: wrap;
    }

    .toolbar label {
      color: #888;
      font-size: 0.85rem;
    }

    .toolbar select,
    .toolbar input {
      background: #1a1a2e;
      border: 1px solid #0f3460;
      color: #eee;
      padding: 0.5rem;
      border-radius: 4px;
      font-size: 0.9rem;
    }

    .toolbar select:focus,
    .toolbar input:focus {
      outline: none;
      border-color: #e94560;
    }

    .toolbar button {
      background: #e94560;
      color: white;
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.9rem;
    }

    .toolbar button:hover {
      background: #ff6b6b;
    }

    .toolbar button.secondary {
      background: #0f3460;
    }

    .toolbar button.secondary:hover {
      background: #1a4a7a;
    }

    .content {
      flex: 1;
      overflow: auto;
      padding: 1rem;
    }

    .tabs {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 1rem;
    }

    .tab {
      padding: 0.5rem 1rem;
      background: #16213e;
      border: 1px solid #0f3460;
      border-radius: 4px;
      cursor: pointer;
      color: #888;
    }

    .tab:hover {
      background: #0f3460;
    }

    .tab.active {
      background: #e94560;
      border-color: #e94560;
      color: white;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.85rem;
    }

    th,
    td {
      padding: 0.5rem 0.75rem;
      text-align: left;
      border-bottom: 1px solid #0f3460;
    }

    th {
      background: #16213e;
      color: #e94560;
      font-weight: 600;
      position: sticky;
      top: 0;
    }

    tr:hover {
      background: rgba(233, 69, 96, 0.1);
    }

    .number {
      font-family: "Monaco", "Consolas", monospace;
      color: #4ecdc4;
    }

    .hex {
      font-family: "Monaco", "Consolas", monospace;
      color: #ffd93d;
    }

    .pagination {
      display: flex;
      gap: 0.5rem;
      align-items: center;
      margin-top: 1rem;
      justify-content: center;
    }

    .pagination button {
      background: #0f3460;
      color: white;
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 4px;
      cursor: pointer;
    }

    .pagination button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .pagination span {
      color: #888;
    }

    .chart-container {
      background: #16213e;
      border-radius: 8px;
      padding: 1rem;
      margin-bottom: 1rem;
    }

    .bar-chart {
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
    }

    .bar-row {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .bar-label {
      width: 100px;
      font-size: 0.8rem;
      text-align: right;
      color: #888;
    }

    .bar-container {
      flex: 1;
      height: 20px;
      background: #1a1a2e;
      border-radius: 4px;
      overflow: hidden;
    }

    .bar {
      height: 100%;
      background: linear-gradient(90deg, #e94560, #ff6b6b);
      border-radius: 4px;
      display: flex;
      align-items: center;
      padding-left: 0.5rem;
      font-size: 0.75rem;
      color: white;
      min-width: fit-content;
    }

    .sql-input {
      width: 100%;
      font-family: "Monaco", "Consolas", monospace;
      font-size: 0.9rem;
      padding: 0.75rem;
      background: #1a1a2e;
      border: 1px solid #0f3460;
      color: #eee;
      border-radius: 4px;
      resize: vertical;
      min-height: 80px;
    }

    .sql-input:focus {
      outline: none;
      border-color: #e94560;
    }

    .loading {
      text-align: center;
      padding: 2rem;
      color: #888;
    }

    .error {
      background: rgba(233, 69, 96, 0.2);
      border: 1px solid #e94560;
      padding: 1rem;
      border-radius: 4px;
      color: #ff6b6b;
    }

    .empty {
      text-align: center;
      padding: 2rem;
      color: #666;
    }

    /* File Structure Modal */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }

    .modal-overlay.active {
      display: flex;
    }

    .modal-container {
      background: #16213e;
      border-radius: 8px;
      max-width: 900px;
      max-height: 80vh;
      width: 90%;
      display: flex;
      flex-direction: column;
      border: 1px solid #0f3460;
    }

    .modal-header {
      padding: 1rem 1.5rem;
      border-bottom: 1px solid #0f3460;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modal-header h2 {
      color: #e94560;
      font-size: 1.2rem;
    }

    .modal-header .close-btn {
      background: none;
      border: none;
      color: #888;
      font-size: 1.5rem;
      cursor: pointer;
    }

    .modal-header .close-btn:hover {
      color: #e94560;
    }

    .modal-body {
      padding: 1rem 1.5rem;
      overflow-y: auto;
      flex: 1;
    }

    .modal-stats {
      display: flex;
      gap: 2rem;
      margin-bottom: 1rem;
      color: #888;
      font-size: 0.9rem;
    }

    .modal-stats .stat-value {
      color: #4ecdc4;
      font-weight: 600;
    }

    .structure-section {
      margin-bottom: 1rem;
      border: 1px solid #0f3460;
      border-radius: 4px;
    }

    .section-header {
      background: #1a1a2e;
      padding: 0.5rem 1rem;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .section-header:hover {
      background: #0f3460;
    }

    .section-name {
      color: #e94560;
      font-weight: 600;
    }

    .section-meta {
      color: #666;
      font-size: 0.8rem;
    }

    .section-fields {
      padding: 0.5rem;
    }

    .field-row {
      display: flex;
      padding: 0.25rem 0.5rem;
      font-size: 0.85rem;
      border-bottom: 1px solid #0f3460;
    }

    .field-row:last-child {
      border-bottom: none;
    }

    .field-name {
      width: 200px;
      color: #888;
    }

    .field-value {
      flex: 1;
      color: #4ecdc4;
      font-family: "Monaco", "Consolas", monospace;
    }

    .field-warning {
      color: #ff6b6b;
      font-size: 0.8rem;
      margin-left: 0.5rem;
    }
  </style>
</head>

<body>
  <div class="header">
    <h1>üîç Vanguard Data Explorer</h1>
    <div class="stats" id="stats">Loading...</div>
  </div>

  <div class="container">
    <div class="sidebar">
      <h3>General</h3>
      <ul class="class-list">
        <li class="class-item" id="nav-files" onclick="showFilesView()">
          <span>üìÅ All Files</span>
        </li>
        <li class="class-item" id="nav-meshes" onclick="showFilesView('Mesh', 'usx')">
          <span>üì¶ Meshes</span>
        </li>
        <li class="class-item" id="nav-shaders" onclick="showFilesView('Texture', 'mat')">
          <span>üé® Shaders</span>
        </li>
        <li class="class-item" id="nav-chunks" onclick="showFilesView('Map', 'vgr')">
          <span>üåç Chunks</span>
        </li>
        <li class="class-item" id="nav-extractors" onclick="showExtractorsView()">
          <span>‚öôÔ∏è Extractors</span>
        </li>
      </ul>

      <h3>Classes</h3>
      <ul class="class-list" id="classList">
        <li class="loading">Loading...</li>
      </ul>
    </div>

    <div class="main">
      <!-- EXTRACTORS VIEW -->
      <div id="extractorExplorer" style="display: none; flex-direction: column; height: 100%;">
        <div class="toolbar">
          <div>
            <label>Search:</label>
            <input type="text" id="extractorSearch" placeholder="Name or description..."
              onkeyup="renderExtractorTable()" />
          </div>
          <div>
            <label>Category:</label>
            <select id="extractorCategory" onchange="renderExtractorTable()">
              <option value="">All Categories</option>
              <option value="Data">Data</option>
              <option value="Mesh">Mesh</option>
              <option value="Terrain">Terrain</option>
              <option value="Texture">Texture</option>
            </select>
          </div>
          <span style="color: #888; margin-left: 1rem;" id="extractorStatus"></span>
        </div>
        <div class="content" style="display: flex; gap: 1rem;">
          <!-- Table List -->
          <div id="extractorsList" style="flex: 1; overflow-y: auto;"></div>
          <!-- Output Panel -->
          <div id="extractorOutput" style="width: 40%; display: none; flex-direction: column;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
              <h4 style="color: #4ecdc4; margin: 0;">Output: <span id="outputExtractorName">-</span></h4>
              <button class="secondary" onclick="closeExtractorOutput()" style="padding: 0.25rem 0.5rem;">‚úï</button>
            </div>
            <pre id="extractorTerminal"
              style="flex: 1; background: #0d0d0d; border: 1px solid #333; border-radius: 4px; padding: 0.75rem; overflow: auto; font-family: Monaco, Consolas, monospace; font-size: 0.75rem; color: #0f0; white-space: pre-wrap; margin: 0;"></pre>
          </div>
        </div>
      </div>

      <!-- FILE EXPLORER VIEW -->
      <div id="fileExplorer" style="display: none; flex-direction: column; height: 100%;">
        <div class="toolbar">
          <div>
            <label>Search:</label>
            <input type="text" id="fileSearch" placeholder="Filename..."
              onkeyup="if(event.key === 'Enter') loadFiles()" />
          </div>
          <div>
            <label>Category:</label>
            <select id="fileCategory" onchange="loadFiles()">
              <option value="">All Categories</option>
              <option value="Mesh">Mesh</option>
              <option value="Texture">Texture</option>
              <option value="Map">Map</option>
              <option value="System">System</option>
              <option value="Audio">Audio</option>
              <option value="Text">Text</option>
              <option value="Config">Config</option>
              <option value="Script">Script</option>
              <option value="Animation">Animation</option>
              <option value="Asset">Asset</option>
              <option value="Unknown">Unknown</option>
            </select>
          </div>
          <div>
            <label>Ext:</label>
            <input type="text" id="fileExt" placeholder="e.g. usx" style="width: 80px;"
              onkeyup="if(event.key === 'Enter') loadFiles()" />
          </div>
          <button onclick="loadFiles()">Search</button>
          <button class="secondary" onclick="clearFileFilters()">Clear</button>
        </div>

        <div class="content" id="filesContent">
          <div id="filesList"></div>
          <div class="pagination" id="filesPagination" style="display: none">
            <button onclick="prevFilesPage()" id="prevFilesBtn">‚Üê Previous</button>
            <span id="filesPageInfo">Page 1</span>
            <button onclick="nextFilesPage()" id="nextFilesBtn">Next ‚Üí</button>
          </div>
        </div>
      </div>

      <!-- File Structure Modal -->
      <div class="modal-overlay" id="structureModal" onclick="closeStructureModal(event)">
        <div class="modal-container" onclick="event.stopPropagation()">
          <div class="modal-header">
            <h2 id="structureModalTitle">File Structure</h2>
            <button class="close-btn" onclick="closeStructureModal()">&times;</button>
          </div>
          <div class="modal-body">
            <div class="modal-stats" id="structureStats"></div>
            <div id="structureContent">Loading...</div>
          </div>
        </div>
      </div>

      <!-- CLASS EXPLORER VIEW (Existing) -->
      <div id="classExplorer" style="display: flex; flex-direction: column; height: 100%;">
        <div class="toolbar">
          <div>
            <label>Chunk:</label>
            <select id="chunkFilter">
              <option value="">All Chunks</option>
            </select>
          </div>
          <div>
            <label>Length:</label>
            <select id="lengthFilter">
              <option value="">All Lengths</option>
            </select>
          </div>
          <button onclick="loadExports()">Apply Filters</button>
          <button class="secondary" onclick="clearFilters()">Clear</button>
        </div>

        <div class="content">
          <div class="tabs">
            <div class="tab active" data-tab="exports" onclick="switchTab('exports')">
              Exports
            </div>
            <div class="tab" data-tab="properties" onclick="switchTab('properties')">
              Properties
            </div>
            <div class="tab" data-tab="distribution" onclick="switchTab('distribution')">
              Length Distribution
            </div>
            <div class="tab" data-tab="sql" onclick="switchTab('sql')">
              SQL Query
            </div>
          </div>

          <div id="exportsTab">
            <div id="exportsTable">
              <p class="empty">
                Select a class from the sidebar to view exports
              </p>
            </div>
            <div class="pagination" id="pagination" style="display: none">
              <button onclick="prevPage()" id="prevBtn">‚Üê Previous</button>
              <span id="pageInfo">Page 1</span>
              <button onclick="nextPage()" id="nextBtn">Next ‚Üí</button>
            </div>
          </div>

          <div id="propertiesTab" style="display: none">
            <div class="chart-container">
              <h3 style="margin-bottom: 1rem; color: #e94560">
                Properties for <span id="propsClassName">-</span>
              </h3>
              <div id="propertiesList">
                <p class="empty">Select a class to view its properties</p>
              </div>
            </div>
            <div id="exportDetail" style="display: none; margin-top: 1rem">
              <div class="chart-container">
                <h3 style="margin-bottom: 1rem; color: #4ecdc4">
                  Export Detail: <span id="detailExportName">-</span>
                </h3>
                <div id="exportProperties"></div>
              </div>
            </div>
          </div>

          <div id="distributionTab" style="display: none">
            <div class="chart-container">
              <h3 style="margin-bottom: 1rem; color: #e94560">
                Length Distribution
              </h3>
              <div id="lengthChart" class="bar-chart">
                <p class="empty">Select a class to view length distribution</p>
              </div>
            </div>
          </div>

          <div id="sqlTab" style="display: none">
            <div style="margin-bottom: 1rem">
              <textarea class="sql-input" id="sqlInput" placeholder="Enter SQL query (SELECT only)...">
  SELECT * FROM class_summary ORDER BY export_count DESC LIMIT 20</textarea>
            </div>
            <button onclick="runQuery()">Run Query</button>
            <div style="margin-top: 1rem">
              <strong>Example queries:</strong>
              <ul style="
                    margin-top: 0.5rem;
                    margin-left: 1.5rem;
                    color: #888;
                    font-size: 0.85rem;
                  ">
                <li style="cursor: pointer; margin: 0.25rem 0"
                  onclick="setQuery('SELECT * FROM class_summary ORDER BY export_count DESC')">
                  Class summary
                </li>
                <li style="cursor: pointer; margin: 0.25rem 0"
                  onclick="setQuery('SELECT * FROM length_distribution WHERE class_name=\'WaterVolume\' ORDER BY count DESC')">
                  WaterVolume lengths
                </li>
                <li style="cursor: pointer; margin: 0.25rem 0"
                  onclick="setQuery('SELECT filename, export_count, name_count FROM chunks ORDER BY export_count DESC LIMIT 20')">
                  Largest chunks
                </li>
                <li style="cursor: pointer; margin: 0.25rem 0"
                  onclick="setQuery('SELECT class_name, COUNT(DISTINCT data_length) as variants FROM exports GROUP BY class_name ORDER BY variants DESC LIMIT 20')">
                  Most length variants
                </li>
              </ul>
            </div>
            <div id="sqlResults" style="margin-top: 1rem"></div>
          </div>
        </div>
      </div>
    </div>

    <script>
      // Automatically use relative path if served via HTTP server, otherwise default to localhost:8000
      const API_BASE = window.location.protocol.startsWith('http') ? "/api" : "http://localhost:8000/api";

      let currentClass = null;
      let currentPage = 0;
      let pageSize = 100;
      let totalExports = 0;
      let classes = [];
      let chunks = [];
      let lengthDistribution = [];

      // File Explorer State
      let currentFilePage = 0;
      let filePageSize = 100;
      let totalFiles = 0;
      let fileSortField = 'size_bytes';
      let fileSortOrder = 'desc';

      // --- File Structure Modal Functions ---

      async function showFileStructure(filePath) {
        const modal = document.getElementById('structureModal');
        const title = document.getElementById('structureModalTitle');
        const stats = document.getElementById('structureStats');
        const content = document.getElementById('structureContent');

        // Show modal with loading state
        modal.classList.add('active');
        title.textContent = filePath.split('/').pop();
        stats.innerHTML = '';
        content.innerHTML = '<p style="color:#888">Loading structure...</p>';

        try {
          const response = await fetch(`${API_BASE}/file_structure?path=${encodeURIComponent(filePath)}`);
          const data = await response.json();

          if (data.error) {
            content.innerHTML = `<p class="error">${data.error}</p>`;
            return;
          }

          // Show stats
          const coverage = data.parsed_bytes && data.total_bytes
            ? ((data.parsed_bytes / data.total_bytes) * 100).toFixed(1)
            : '?';
          stats.innerHTML = `
            <div>Type: <span class="stat-value">${data.type || 'Unknown'}</span></div>
            <div>Export: <span class="stat-value">${data.export_name || '-'}</span></div>
            <div>Size: <span class="stat-value">${data.total_bytes} bytes</span></div>
            <div>Parsed: <span class="stat-value">${data.parsed_bytes} bytes (${coverage}%)</span></div>
          `;

          // Render structure
          content.innerHTML = renderStructure(data.sections || []);

        } catch (e) {
          content.innerHTML = `<p class="error">Failed to load structure: ${e.message}</p>`;
        }
      }

      function closeStructureModal(event) {
        // If called from overlay click, only close if target is overlay
        if (event && event.target !== document.getElementById('structureModal')) {
          return;
        }
        document.getElementById('structureModal').classList.remove('active');
      }

      function renderStructure(sections) {
        if (!sections || sections.length === 0) {
          return '<p style="color:#666">No structure data available</p>';
        }

        return sections.map(section => {
          const hasWarning = section.fields && section.fields.some(f => f.warning);
          const warningClass = hasWarning ? 'style="border-color: #ff6b6b;"' : '';

          const fieldsHtml = (section.fields || []).map(field => {
            // Format value
            let valueStr = String(field.value);
            if (typeof field.value === 'number' && !Number.isInteger(field.value)) {
              valueStr = field.value.toFixed(6);
            }

            const warningHtml = field.warning
              ? `<span class="field-warning">‚ö† ${field.warning}</span>`
              : '';

            return `
              <div class="field-row">
                <span class="field-name">${field.name}</span>
                <span class="field-value">${valueStr}</span>
                ${warningHtml}
              </div>
            `;
          }).join('');

          return `
            <div class="structure-section" ${warningClass}>
              <div class="section-header">
                <span class="section-name">${section.name}</span>
                <span class="section-meta">Offset: ${section.offset} | Size: ${section.size} bytes</span>
              </div>
              <div class="section-fields">
                ${fieldsHtml || '<em style="color:#666">No fields</em>'}
              </div>
            </div>
          `;
        }).join('');
      }

      async function init() {
        await loadClasses();
        await loadChunks();
        updateStats();
      }

      // --- View Switching ---

      // --- View Switching ---

      function showFilesView(categoryPreset = null, extPreset = null) {
        document.getElementById('fileExplorer').style.display = 'flex';
        document.getElementById('classExplorer').style.display = 'none';
        document.getElementById('extractorExplorer').style.display = 'none';

        // Reset filters if preset provided
        if (categoryPreset || extPreset) {
          document.getElementById('fileCategory').value = categoryPreset || '';
          document.getElementById('fileExt').value = extPreset || '';
          document.getElementById('fileSearch').value = '';
          currentFilePage = 0;
        }

        // Update Sidebar
        document.querySelectorAll('.class-item').forEach(el => el.classList.remove('active'));

        // Highlight correct nav item based on category
        if (categoryPreset === 'Mesh') document.getElementById('nav-meshes').classList.add('active');
        else if (categoryPreset === 'Texture' && extPreset === 'mat') document.getElementById('nav-shaders').classList.add('active');
        else if (categoryPreset === 'Map' && extPreset === 'vgr') document.getElementById('nav-chunks').classList.add('active');
        else document.getElementById('nav-files').classList.add('active');

        loadFiles();
      }

      function showClassView() {
        document.getElementById('fileExplorer').style.display = 'none';
        document.getElementById('classExplorer').style.display = 'flex';
        document.getElementById('extractorExplorer').style.display = 'none';
        document.getElementById('extractorExplorer').style.display = 'none';

        // Remove active class from all nav items
        document.querySelectorAll('.class-item').forEach(el => el.classList.remove('active'));
      }

      function showExtractorsView() {
        document.getElementById('fileExplorer').style.display = 'none';
        document.getElementById('classExplorer').style.display = 'none';
        document.getElementById('extractorExplorer').style.display = 'flex';

        // Update Sidebar
        document.querySelectorAll('.class-item').forEach(el => el.classList.remove('active'));
        document.getElementById('nav-extractors').classList.add('active');

        loadExtractors();
      }

      // --- Extractors Logic ---

      let extractorsList = [];

      async function loadExtractors() {
        const container = document.getElementById('extractorsList');
        container.innerHTML = '<p class="loading">Loading extractors...</p>';

        try {
          const response = await fetch(`${API_BASE}/extractors`);
          extractorsList = await response.json();
          renderExtractorTable();
        } catch (e) {
          container.innerHTML = '<p class="error">Failed to load extractors: ' + e.message + '</p>';
        }
      }

      function renderExtractorTable() {
        const container = document.getElementById('extractorsList');
        const search = document.getElementById('extractorSearch').value.toLowerCase();
        const category = document.getElementById('extractorCategory').value;

        // Filter
        const filtered = extractorsList.filter(ext => {
          const matchesSearch = !search ||
            ext.name.toLowerCase().includes(search) ||
            ext.description.toLowerCase().includes(search) ||
            ext.script.toLowerCase().includes(search);
          const matchesCategory = !category || ext.category === category;
          return matchesSearch && matchesCategory;
        });

        if (!filtered.length) {
          container.innerHTML = '<p class="empty">No extractors found</p>';
          return;
        }

        container.innerHTML = `
            <table>
                <thead>
                    <tr>
                        <th style="width: 15%">Name / Category</th>
                        <th style="width: 20%">Script</th>
                        <th style="width: 30%">Description</th>
                        <th style="width: 15%">Inputs</th>
                        <th style="width: 15%">Outputs</th>
                        <th style="width: 80px">Action</th>
                    </tr>
                </thead>
                <tbody>
                    ${filtered.map(ext => `
                        <tr>
                            <td>
                                <strong style="color: #4ecdc4; display: block;">${ext.name}</strong>
                                <span style="font-size: 0.75rem; color: #888; background: #222; padding: 2px 6px; border-radius: 4px;">${ext.category || 'Other'}</span>
                            </td>
                            <td style="font-family: monospace; font-size: 0.85em; color: #aaa;">${ext.script}</td>
                            <td style="color: #ccc;">${ext.description}</td>
                            <td style="font-size: 0.8em; color: #888;">${ext.inputs}</td>
                            <td style="font-size: 0.8em; color: #888;">${ext.outputs}</td>
                            <td>
                                <button onclick="runExtractor('${ext.id}')" id="btn-${ext.id}" style="font-size: 0.8rem; padding: 0.25rem 0.5rem; width: 100%;">‚ñ∂ Run</button>
                            </td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        `;
      }

      async function runExtractor(extractorId) {
        const btn = document.getElementById(`btn-${extractorId}`);
        const extractor = extractorsList.find(e => e.id === extractorId);

        // Show output panel
        const outputPanel = document.getElementById('extractorOutput');
        const terminal = document.getElementById('extractorTerminal');
        const nameSpan = document.getElementById('outputExtractorName');

        outputPanel.style.display = 'flex';
        nameSpan.textContent = extractor ? extractor.name : extractorId;
        terminal.textContent = `Running ${extractorId}...\n`;

        // Update button
        btn.disabled = true;
        btn.textContent = '‚è≥ Running...';
        document.getElementById('extractorStatus').textContent = `Running: ${extractor ? extractor.name : extractorId}`;

        try {
          const response = await fetch(`${API_BASE}/run_extractor?id=${encodeURIComponent(extractorId)}`);
          const result = await response.json();

          if (result.success) {
            terminal.textContent = result.stdout || '(no output)';
            if (result.stderr) {
              terminal.textContent += '\n\n--- STDERR ---\n' + result.stderr;
            }
            terminal.style.color = '#0f0';
            document.getElementById('extractorStatus').textContent = `‚úì ${extractor ? extractor.name : extractorId} completed`;
          } else {
            terminal.textContent = `Error (code ${result.returncode}):\n\n${result.stderr || result.stdout || 'Unknown error'}`;
            terminal.style.color = '#f66';
            document.getElementById('extractorStatus').textContent = `‚úó ${extractor ? extractor.name : extractorId} failed`;
          }
        } catch (e) {
          terminal.textContent = `Failed to run extractor: ${e.message}`;
          terminal.style.color = '#f66';
          document.getElementById('extractorStatus').textContent = `‚úó Error`;
        } finally {
          btn.disabled = false;
          btn.textContent = '‚ñ∂ Run';
        }
      }

      function closeExtractorOutput() {
        document.getElementById('extractorOutput').style.display = 'none';
        document.getElementById('extractorStatus').textContent = '';
      }

      // --- File Explorer Logic ---

      async function loadFiles() {
        const search = document.getElementById('fileSearch').value;
        const category = document.getElementById('fileCategory').value;
        const ext = document.getElementById('fileExt').value;

        const params = new URLSearchParams({
          limit: filePageSize,
          offset: currentFilePage * filePageSize,
          sort: fileSortField,
          order: fileSortOrder
        });

        if (search) params.append('search', search);
        if (category) params.append('category', category);
        if (ext) params.append('extension', ext);

        try {
          // Only show loading if empty or first load? optional
          // document.getElementById('filesList').innerHTML = '<p class="loading">Loading files...</p>';

          const response = await fetch(`${API_BASE}/files?${params}`);
          const data = await response.json();

          totalFiles = data.total;
          renderFilesTable(data.rows);
          updateFilesPagination();

        } catch (e) {
          document.getElementById('filesList').innerHTML = '<p class="error">Failed to load files: ' + e.message + '</p>';
        }
      }

      function renderFilesTable(rows) {
        const container = document.getElementById('filesList');
        if (!rows.length) {
          container.innerHTML = '<p class="empty">No files found</p>';
          return;
        }

        container.innerHTML = `
            <table>
                <thead>
                    <tr>
                        <th style="width: 25%; cursor: pointer;" onclick="sortFiles('location')">Location ${getSortIndicator('location')}</th>
                        <th style="cursor: pointer;" onclick="sortFiles('file_name')">Name ${getSortIndicator('file_name')}</th>
                        <th style="width: 80px; cursor: pointer;" onclick="sortFiles('extension')">Ext ${getSortIndicator('extension')}</th>
                        <th style="width: 100px; cursor: pointer;" onclick="sortFiles('size_bytes')">Size ${getSortIndicator('size_bytes')}</th>
                        <th style="width: 80px;">Cov %</th>
                        <th style="width: 60px;">Extr.</th>
                        <th>Notes</th>
                    </tr>
                </thead>
                <tbody>
                    ${rows.map(f => {
          // Coverage Color
          let covColor = '#ff6b6b';
          if (f.parse_coverage_pct > 99) covColor = '#4ecdc4';
          else if (f.parse_coverage_pct > 50) covColor = '#ffe66d';

          // Extracted Icon
          const extrIcon = f.is_extracted ? '<span style="color:#4ecdc4">‚úì</span>' : '<span style="color:#666">‚úó</span>';

          return `
                        <tr>
                            <td style="color:#888; font-size:0.8em; word-break: break-all;" title="${f.location}">${f.location || './'}</td>
                            <td>
                                <button onclick="showFileStructure('${f.file_path}')" style="background:none; border:none; color:#4ecdc4; font-weight:500; cursor:pointer; text-align:left; font-size:inherit;">
                                    ${f.file_name}
                                </button>
                            </td>
                            <td><span style="background:#222; padding:2px 4px; border-radius:3px; font-size:0.8em; color:#aaa;">${f.extension}</span></td>
                            <td class="number" style="font-size:0.9em;">${formatBytes(f.size_bytes)}</td>
                            <td class="number">
                                <span style="color:${covColor}">${f.parse_coverage_pct ? f.parse_coverage_pct.toFixed(1) + '%' : '-'}</span>
                            </td>
                            <td style="text-align:center;">${extrIcon}</td>
                            <td style="font-size:0.8em; color:#888; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:200px;" title="${f.parser_notes || ''}">
                                ${f.parser_notes || '-'}
                            </td>
                        </tr>
                        `;
        }).join('')}
                </tbody>
            </table>
          `;
      }

      function formatBytes(bytes, decimals = 2) {
        if (!+bytes) return '0 Bytes';
        const k = 1024;
        const dm = decimals < 0 ? 0 : decimals;
        const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return `${parseFloat((bytes / Math.pow(k, i)).toFixed(dm))} ${sizes[i]}`;
      }

      function sortFiles(field) {
        if (fileSortField === field) {
          fileSortOrder = fileSortOrder === 'asc' ? 'desc' : 'asc';
        } else {
          fileSortField = field;
          fileSortOrder = (field === 'size_bytes' || field === 'modified_time') ? 'desc' : 'asc';
        }
        currentFilePage = 0;
        loadFiles();
      }

      function getSortIndicator(field) {
        if (fileSortField !== field) return '<span style="color: #444">‚Üï</span>';
        return fileSortOrder === 'asc' ? '‚Üë' : '‚Üì';
      }

      function updateFilesPagination() {
        const pagination = document.getElementById("filesPagination");
        const totalPages = Math.ceil(totalFiles / filePageSize);

        if (totalPages <= 1) {
          pagination.style.display = "none";
          return;
        }

        pagination.style.display = "flex";
        document.getElementById("filesPageInfo").textContent = `Page ${currentFilePage + 1} of ${totalPages} (${totalFiles.toLocaleString()} files)`;
        document.getElementById("prevFilesBtn").disabled = currentFilePage === 0;
        document.getElementById("nextFilesBtn").disabled = currentFilePage >= totalPages - 1;
      }

      function prevFilesPage() {
        if (currentFilePage > 0) {
          currentFilePage--;
          loadFiles();
        }
      }

      function nextFilesPage() {
        const totalPages = Math.ceil(totalFiles / filePageSize);
        if (currentFilePage < totalPages - 1) {
          currentFilePage++;
          loadFiles();
        }
      }

      function clearFileFilters() {
        document.getElementById('fileSearch').value = '';
        document.getElementById('fileCategory').value = '';
        document.getElementById('fileExt').value = '';
        currentFilePage = 0;
        loadFiles();
      }


      // --- Existing Logic ---

      async function loadClasses() {
        try {
          const response = await fetch(`${API_BASE}/class_summary`);
          classes = await response.json();
          renderClassList();
        } catch (e) {
          document.getElementById("classList").innerHTML =
            '<li class="error">Failed to load classes</li>';
        }
      }

      async function loadChunks() {
        try {
          const response = await fetch(`${API_BASE}/chunks`);
          chunks = await response.json();

          const select = document.getElementById("chunkFilter");
          chunks.forEach((chunk) => {
            const option = document.createElement("option");
            option.value = chunk.id;
            option.textContent = chunk.filename;
            select.appendChild(option);
          });
        } catch (e) {
          console.error("Failed to load chunks:", e);
        }
      }

      function updateStats() {
        const totalExports = classes.reduce(
          (sum, c) => sum + c.export_count,
          0
        );
        document.getElementById("stats").textContent = `${chunks.length
          } chunks ‚Ä¢ ${totalExports.toLocaleString()} exports ‚Ä¢ ${classes.length
          } classes`;
      }

      function renderClassList() {
        const list = document.getElementById("classList");
        list.innerHTML = classes
          .map(
            (c) => `
                <li class="class-item ${currentClass === c.class_name ? "active" : ""
              }" 
                    onclick="selectClass('${c.class_name}')">
                    <span>${c.class_name}</span>
                    <span class="count">${c.export_count.toLocaleString()}</span>
                </li>
            `
          )
          .join("");
      }

      async function selectClass(className) {
        showClassView();
        currentClass = className;
        currentPage = 0;
        renderClassList();
        await loadLengthDistribution();
        await loadExports();
      }

      async function loadLengthDistribution() {
        if (!currentClass) return;

        try {
          const response = await fetch(
            `${API_BASE}/length_distribution?class=${encodeURIComponent(
              currentClass
            )}`
          );
          lengthDistribution = await response.json();

          // Update length filter
          const select = document.getElementById("lengthFilter");
          select.innerHTML = '<option value="">All Lengths</option>';
          lengthDistribution.forEach((d) => {
            const option = document.createElement("option");
            option.value = d.data_length;
            option.textContent = `${d.data_length} bytes (${d.count})`;
            select.appendChild(option);
          });

          renderLengthChart();
        } catch (e) {
          console.error("Failed to load length distribution:", e);
        }
      }

      function renderLengthChart() {
        const container = document.getElementById("lengthChart");

        if (!lengthDistribution.length) {
          container.innerHTML = '<p class="empty">No data</p>';
          return;
        }

        const maxCount = Math.max(...lengthDistribution.map((d) => d.count));

        container.innerHTML = lengthDistribution
          .slice(0, 20)
          .map(
            (d) => `
                <div class="bar-row">
                    <div class="bar-label">${d.data_length} bytes</div>
                    <div class="bar-container">
                        <div class="bar" style="width: ${(d.count / maxCount) * 100
              }%">
                            ${d.count} (${d.pct}%)
                        </div>
                    </div>
                </div>
            `
          )
          .join("");

        if (lengthDistribution.length > 20) {
          container.innerHTML += `<p style="color: #888; margin-top: 0.5rem; font-size: 0.8rem;">
                    ... and ${lengthDistribution.length - 20
            } more length variants
                </p>`;
        }
      }

      async function loadExports() {
        if (!currentClass) return;

        const chunkId = document.getElementById("chunkFilter").value;
        const length = document.getElementById("lengthFilter").value;

        const params = new URLSearchParams({
          class: currentClass,
          limit: pageSize,
          offset: currentPage * pageSize,
        });

        if (chunkId) params.append("chunk_id", chunkId);
        if (length) params.append("length", length);

        try {
          const response = await fetch(`${API_BASE}/exports?${params}`);
          const data = await response.json();

          totalExports = data.total;
          renderExportsTable(data.rows);
          updatePagination();
        } catch (e) {
          document.getElementById("exportsTable").innerHTML =
            '<p class="error">Failed to load exports</p>';
        }
      }

      function renderExportsTable(rows) {
        const container = document.getElementById("exportsTable");

        if (!rows.length) {
          container.innerHTML = '<p class="empty">No exports found</p>';
          return;
        }

        container.innerHTML = `
                <table>
                    <thead>
                        <tr>
                            <th>Object Name</th>
                            <th>Chunk</th>
                            <th>Length</th>
                            <th>Position (X, Y, Z)</th>
                            <th>Header</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${rows
            .map(
              (row) => `
                            <tr style="cursor: pointer;" onclick="showExportDetail(${row.id
                }); switchTab('properties');">
                                <td>${row.object_name}</td>
                                <td>${row.chunk_name}</td>
                                <td class="number">${row.data_length}</td>
                                <td class="number">
                                    ${row.position_x
                  ? `${row.position_x.toFixed(
                    0
                  )}, ${row.position_y.toFixed(
                    0
                  )}, ${row.position_z.toFixed(0)}`
                  : "-"
                }
                                </td>
                                <td class="hex">${row.header_bytes || "-"}</td>
                            </tr>
                        `
            )
            .join("")}
                    </tbody>
                </table>
            `;
      }

      function updatePagination() {
        const pagination = document.getElementById("pagination");
        const totalPages = Math.ceil(totalExports / pageSize);

        if (totalPages <= 1) {
          pagination.style.display = "none";
          return;
        }

        pagination.style.display = "flex";
        document.getElementById("pageInfo").textContent = `Page ${currentPage + 1
          } of ${totalPages} (${totalExports.toLocaleString()} total)`;
        document.getElementById("prevBtn").disabled = currentPage === 0;
        document.getElementById("nextBtn").disabled =
          currentPage >= totalPages - 1;
      }

      function prevPage() {
        if (currentPage > 0) {
          currentPage--;
          loadExports();
        }
      }

      function nextPage() {
        const totalPages = Math.ceil(totalExports / pageSize);
        if (currentPage < totalPages - 1) {
          currentPage++;
          loadExports();
        }
      }

      function clearFilters() {
        document.getElementById("chunkFilter").value = "";
        document.getElementById("lengthFilter").value = "";
        currentPage = 0;
        loadExports();
      }

      function switchTab(tabName) {
        document
          .querySelectorAll(".tab")
          .forEach((t) => t.classList.remove("active"));
        document
          .querySelector(`.tab[data-tab="${tabName}"]`)
          .classList.add("active");

        document.getElementById("exportsTab").style.display =
          tabName === "exports" ? "block" : "none";
        document.getElementById("propertiesTab").style.display =
          tabName === "properties" ? "block" : "none";
        document.getElementById("distributionTab").style.display =
          tabName === "distribution" ? "block" : "none";
        document.getElementById("sqlTab").style.display =
          tabName === "sql" ? "block" : "none";

        if (tabName === "properties" && currentClass) {
          loadPropertySummary();
        }
      }

      async function loadPropertySummary() {
        if (!currentClass) return;

        document.getElementById("propsClassName").textContent = currentClass;
        const container = document.getElementById("propertiesList");
        container.innerHTML = '<p class="loading">Loading properties...</p>';

        try {
          const response = await fetch(
            `${API_BASE}/property_summary?class=${encodeURIComponent(
              currentClass
            )}`
          );
          const props = await response.json();

          if (!props.length) {
            container.innerHTML =
              '<p class="empty">No properties found for this class</p>';
            return;
          }

          container.innerHTML = `
            <table>
              <thead>
                <tr>
                  <th>Property Name</th>
                  <th>Type</th>
                  <th>Count</th>
                  <th>Unique Values</th>
                </tr>
              </thead>
              <tbody>
                ${props
              .map(
                (p) => `
                  <tr style="cursor: pointer;" onclick="showPropertyValues('${p.prop_name
                  }')">
                    <td>${p.prop_name}</td>
                    <td class="hex">${p.prop_type}</td>
                    <td class="number">${p.count}</td>
                    <td class="number">${p.unique_values || "-"}</td>
                  </tr>
                `
              )
              .join("")}
              </tbody>
            </table>
          `;
        } catch (e) {
          container.innerHTML = `<p class="error">Failed to load properties: ${e.message}</p>`;
        }
      }

      async function showPropertyValues(propName) {
        const container = document.getElementById("exportDetail");
        const propsContainer = document.getElementById("exportProperties");

        container.style.display = "block";
        document.getElementById(
          "detailExportName"
        ).textContent = `${currentClass}.${propName}`;
        propsContainer.innerHTML = '<p class="loading">Loading values...</p>';

        try {
          const response = await fetch(
            `${API_BASE}/properties?class=${encodeURIComponent(
              currentClass
            )}&prop_name=${encodeURIComponent(propName)}`
          );
          const values = await response.json();

          if (!values.length) {
            propsContainer.innerHTML = '<p class="empty">No values found</p>';
            return;
          }

          propsContainer.innerHTML = `
            <table>
              <thead>
                <tr>
                  <th>Object</th>
                  <th>Chunk</th>
                  <th>Value</th>
                  <th>Hex</th>
                </tr>
              </thead>
              <tbody>
                ${values
              .slice(0, 50)
              .map(
                (v) => `
                  <tr>
                    <td>${v.object_name}</td>
                    <td>${v.filename}</td>
                    <td class="number">${v.value_text || "-"}</td>
                    <td class="hex">${v.value_hex
                    ? v.value_hex.substring(0, 24) +
                    (v.value_hex.length > 24 ? "..." : "")
                    : "-"
                  }</td>
                  </tr>
                `
              )
              .join("")}
              </tbody>
            </table>
            ${values.length > 50
              ? `<p style="color: #888; margin-top: 0.5rem;">Showing 50 of ${values.length} values</p>`
              : ""
            }
          `;
        } catch (e) {
          propsContainer.innerHTML = `<p class="error">Failed to load values: ${e.message}</p>`;
        }
      }

      async function showExportDetail(exportId) {
        const container = document.getElementById("exportDetail");
        const propsContainer = document.getElementById("exportProperties");

        container.style.display = "block";
        propsContainer.innerHTML =
          '<p class="loading">Loading export details...</p>';

        try {
          const response = await fetch(
            `${API_BASE}/export_detail?id=${exportId}`
          );
          const data = await response.json();

          if (data.error) {
            propsContainer.innerHTML = `<p class="error">${data.error}</p>`;
            return;
          }

          document.getElementById("detailExportName").textContent =
            data.export.object_name;

          let html = `
            <div style="margin-bottom: 1rem; padding: 0.5rem; background: #1a1a2e; border-radius: 4px;">
              <strong>Chunk:</strong> ${data.export.chunk_name}<br>
              <strong>Length:</strong> ${data.export.data_length} bytes<br>
              <strong>Position:</strong> ${data.export.position_x
              ? `${data.export.position_x.toFixed(
                0
              )}, ${data.export.position_y.toFixed(
                0
              )}, ${data.export.position_z.toFixed(0)}`
              : "-"
            }<br>
              <strong>Header:</strong> <span class="hex">${data.export.header_bytes || "-"
            }</span>
            </div>
          `;

          if (data.properties.length) {
            html += `
              <table>
                <thead>
                  <tr>
                    <th>Property</th>
                    <th>Type</th>
                    <th>Size</th>
                    <th>Value</th>
                  </tr>
                </thead>
                <tbody>
                  ${data.properties
                .map(
                  (p) => `
                    <tr>
                      <td>${p.prop_name}${p.struct_name ? ` (${p.struct_name})` : ""
                    }</td>
                      <td class="hex">${p.prop_type}</td>
                      <td class="number">${p.prop_size}</td>
                      <td>${p.value_text ||
                    `<span class="hex">${p.value_hex ? p.value_hex.substring(0, 32) : "-"
                    }</span>`
                    }</td>
                    </tr>
                  `
                )
                .join("")}
                </tbody>
              </table>
            `;
          } else {
            html += '<p class="empty">No properties parsed for this export</p>';
          }

          propsContainer.innerHTML = html;
        } catch (e) {
          propsContainer.innerHTML = `<p class="error">Failed to load export: ${e.message}</p>`;
        }
      }

      function setQuery(sql) {
        document.getElementById("sqlInput").value = sql;
      }

      async function runQuery() {
        const sql = document.getElementById("sqlInput").value;
        const container = document.getElementById("sqlResults");

        container.innerHTML = '<p class="loading">Running query...</p>';

        try {
          const response = await fetch(
            `${API_BASE}/query?sql=${encodeURIComponent(sql)}`
          );
          const data = await response.json();

          if (data.error) {
            container.innerHTML = `<p class="error">${data.error}</p>`;
            return;
          }

          if (!data.rows.length) {
            container.innerHTML = '<p class="empty">No results</p>';
            return;
          }

          container.innerHTML = `
                    <p style="color: #888; margin-bottom: 0.5rem;">${data.count
            } rows returned</p>
                    <div style="overflow-x: auto;">
                        <table>
                            <thead>
                                <tr>
                                    ${data.columns
              .map((c) => `<th>${c}</th>`)
              .join("")}
                                </tr>
                            </thead>
                            <tbody>
                                ${data.rows
              .map(
                (row) => `
                                    <tr>
                                        ${data.columns
                    .map(
                      (c) => `<td>${row[c] ?? "-"}</td>`
                    )
                    .join("")}
                                    </tr>
                                `
              )
              .join("")}
                            </tbody>
                        </table>
                    </div>
                `;
        } catch (e) {
          container.innerHTML = `<p class="error">Query failed: ${e.message}</p>`;
        }
      }

      // Initialize
      init();
    </script>
</body>

</html>